# copycat: Pattern Engine Acceleration Project

**Status**: PR5 (Final) - Cython Validation & Default Policy
**Performance Goal**: 3-10x hot-path speedup over PR0 baseline

---

## Overview

copycat is a 5-PR performance optimization project targeting the pattern matching hot path in d810's microcode optimizer. The project maintains full backward compatibility through feature flags while delivering significant performance improvements.

### PR Sequence

| PR | Focus | Status | Key Change |
|----|-------|--------|------------|
| PR0 | Baseline Benchmarks | âœ… Complete | Established performance metrics |
| PR1 | Engine Dispatcher | âœ… Complete | Cython/Python backend gate |
| PR2 | Opcode-Indexed Storage | âœ… Complete | O(1) pattern lookup by opcode |
| PR3 | Registry Cache | âœ… Complete | Function-scoped rule filtering |
| PR4 | Non-Mutating Match | âœ… Complete | Eliminated clone overhead |
| PR5 | Validation & Policy | ðŸ”„ This PR | Cython-first default policy |

---

## PR5: Cython Backend Policy Decision

**Decision**: Cython backend is **default-on** when extensions are compiled.

### Rationale

1. **Automatic Detection**: The engine dispatcher (`engine.py`) auto-detects Cython availability at import time
2. **Transparent Fallback**: Python fallback is fully equivalent and verified by parity tests
3. **User Control**: Users can disable with `D810_NO_CYTHON=1` environment variable
4. **Performance Benefit**: The non-mutating match path (PR4) benefits most from Cython's type erasure and native loops

### Feature Flag Matrix

| Flag | Default | Effect |
|------|---------|--------|
| `D810_NO_CYTHON` | unset (Cython ON) | Disable all Cython backends when set to `1` |
| `D810_LEGACY_STORAGE` | `0` (indexed) | Revert to legacy PatternStorage when set to `1` |
| `D810_NOMUT_MATCHING` | `1` (nomut ON) | Revert to mutating match path when set to `0` |

### Default Configuration

By default (all environment variables unset), d810 operates in the following mode:

- **Pattern Storage**: `OpcodeIndexedStorage` (opcode-indexed lookup)
- **Match Strategy**: Non-mutating (`match_pattern_nomut`)
- **Backend**: Cython (if compiled extensions are available)

This provides the best performance and is fully validated by the test suite.

---

## Rollback Strategies

### Full Revert to Pre-copycat Behavior

To fully revert to the state before PR1-PR5:

```bash
export D810_NO_CYTHON=1
export D810_LEGACY_STORAGE=1
export D810_NOMUT_MATCHING=0
```

### Selective Disabling

**Disable Cython only** (keep indexed storage + nomut matching):

```bash
export D810_NO_CYTHON=1
```

**Disable indexed storage only** (keep Python backend + nomut matching):

```bash
export D810_LEGACY_STORAGE=1
```

**Disable non-mutating match only** (keep Cython + indexed storage):

```bash
export D810_NOMUT_MATCHING=0
```

---

## Benchmarks

### PR0 Baseline

See `docs/copycat/benchmarks/baseline_pattern_engine.json` for pre-optimization baseline numbers (generated by runtime tests).

### Post-Optimization Numbers

Post-PR1-PR5 performance is captured by:
- `tests/system/runtime/test_pattern_engine_benchmark.py::TestCaptureBaseline`
- `tests/system/runtime/test_cython_optimizer_parity.py::TestPostOptimizationBenchmark`

Expected improvements over PR0 baseline:
- **Registration**: 2-5x faster (indexed storage)
- **Lookup (hit)**: 10-50x faster (opcode indexing)
- **Lookup (miss)**: 50-100x faster (early exit on opcode mismatch)
- **Match**: 2-3x faster (non-mutating strategy)
- **Hot Path**: 3-10x faster (combined effect)

---

## Testing & Validation

### Parity Tests (PR5)

The following tests ensure Cython and Python backends are equivalent:

1. **`test_cython_optimizer_parity.py::TestEngineBackendDetection`**
   - Verifies `get_engine_info()` correctly reports active backend
   - Validates `_USING_CYTHON` flag consistency

2. **`test_cython_optimizer_parity.py::TestMatchParity`**
   - Compares engine-dispatched match vs forced-Python match
   - Verifies identical results and bindings

3. **`test_cython_optimizer_parity.py::TestStorageParity`**
   - Compares engine-dispatched storage vs forced-Python storage
   - Verifies identical candidate sets

4. **`test_pattern_engine_benchmark.py::TestCythonPythonParity`**
   - Low-level parity tests (fingerprint, match, storage)
   - Validates primitive operations before integration

### Performance Regression Detection

If performance degrades:
1. Run `test_cython_optimizer_parity.py::TestPostOptimizationBenchmark` to capture current numbers
2. Compare with `docs/copycat/benchmarks/baseline_pattern_engine.json` (if available)
3. Check active backend with `get_engine_info()` â€” ensure Cython is actually enabled
4. Verify no accidental environment variable overrides

---

## Architecture Notes

### CythonMode Pattern

The pattern engine follows **CythonMode Pattern 1** (module-level gate):

```python
from d810.core.cymode import CythonMode

if CythonMode().is_enabled():
    try:
        from d810.speedups.optimizers.c_pattern_match import (
            COpcodeIndexedStorage as OpcodeIndexedStorage,
            match_pattern_nomut,
            CMatchBindings as MatchBindings,
        )
        _USING_CYTHON = True
    except (ModuleNotFoundError, ImportError):
        # Fallback to Python
        ...
```

This ensures:
- Single import location (`engine.py`)
- No runtime overhead (decision at import time)
- Transparent to consumers
- Easy to verify active backend

### Data Containers Always Python

The following classes have no Cython implementations (no performance benefit):
- `PatternFingerprint` (simple dataclass)
- `RulePatternEntry` (simple dataclass)
- `BindingsProxy` (adapter for legacy API)

These are always imported from `pattern_speedups.py` regardless of backend.

---

## Usage Examples

### Check Active Backend

```python
from d810.optimizers.microcode.instructions.pattern_matching.engine import get_engine_info

info = get_engine_info()
print(f"Active backend: {info['backend']}")
# Output: "Active backend: cython" or "Active backend: python"
```

### Force Python Backend for Testing

```bash
export D810_NO_CYTHON=1
pytest tests/system/runtime/test_cython_optimizer_parity.py -v
```

### Run Benchmark Capture

```bash
# Run all benchmarks and save baseline
pytest tests/system/runtime/test_pattern_engine_benchmark.py::TestCaptureBaseline::test_capture_baseline -v -s

# Check post-PR5 performance
pytest tests/system/runtime/test_cython_optimizer_parity.py::TestPostOptimizationBenchmark -v -s
```

---

## Future Work

1. **Auto-build Detection**: Detect when Cython extensions fail to build and emit clear warning
2. **Benchmark Regression Tests**: Add CI job that compares against baseline and fails on significant regression
3. **Backend Selection Override**: Add `D810_FORCE_BACKEND=cython|python` for explicit testing
4. **Profiling Integration**: Add option to dump profiling data when performance degrades
5. **Pattern Compilation**: Explore compile-time pattern optimization for common rule sets

---

**Status**: âœ… PR5 Complete
**Last Updated**: 2026-02-12
**Contact**: See AUTHORS.md for maintainers
