name: d810-ng tests

on:
    push:
        branches: ["main"]
    pull_request:
        types: [synchronize, opened, reopened, ready_for_review]
        branches: ["main"]

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

jobs:
    ast-grep:
        name: "ast-grep"
        runs-on: ubuntu-24.04
        steps:
            - uses: actions/checkout@v4
              with:
                  persist-credentials: false
            - uses: actions/setup-node@v4
              with:
                  node-version: "20"
            - name: Install ast-grep
              run: |
                  npm install -g @ast-grep/cli
            - name: Run ast-grep rules
              run: |
                  sg scan --config sgconfig.yml

    unit-tests:
        name: "unit-tests (py${{ matrix.python-version }})"
        runs-on: ubuntu-24.04
        strategy:
            matrix:
                python-version: ["3.10", "3.11", "3.12", "3.13"]
        env:
            PYTHONPATH: ${{ github.workspace }}
        steps:
            - uses: actions/checkout@v4
              with:
                  persist-credentials: false
            - uses: actions/setup-python@v5
              with:
                  python-version: ${{ matrix.python-version }}
                  cache: pip
            - name: Install dependencies
              run: |
                  pip install --upgrade pip setuptools wheel uv
                  uv pip install --system -e .
                  uv pip install --system pytest pytest-cov import-linter
            - name: Check import boundaries
              run: |
                  lint-imports
            - name: Check borrowed mop_t patterns
              run: |
                  pip install ast-grep-cli
                  sg scan --rule rules/no-borrowed-mop-storage.yml
            - name: Run pytest
              run: |
                  pytest tests/unit/ -v --tb=short

    build-speedups:
        name: "speedups (py${{ matrix.python-version }}, ${{ matrix.os }})"
        runs-on: ${{ matrix.os }}
        strategy:
            fail-fast: false
            matrix:
                os: [ubuntu-24.04]
                python-version: ["3.11", "3.12", "3.13"]
        env:
            PYTHONPATH: ${{ github.workspace }}
            D810_BUILD_SPEEDUPS: "1"
            IDA_SDK: ${{ github.workspace }}/.ida-sdk
        steps:
            - uses: actions/checkout@v4
              with:
                  persist-credentials: false

            - uses: actions/setup-python@v5
              with:
                  python-version: ${{ matrix.python-version }}
                  cache: pip

            - name: Install build dependencies
              run: |
                  pip install --upgrade pip setuptools wheel uv
                  uv pip install --system Cython>=3.0.0

            - name: Clone IDA SDK
              run: |
                  if [ -d ".ida-sdk/src/include" ]; then
                    echo "IDA SDK already present, skipping clone"
                  else
                    rm -rf .ida-sdk
                    git clone https://github.com/HexRaysSA/ida-sdk.git .ida-sdk
                    cd .ida-sdk
                    # This is the commit that last works on 9.2
                    git checkout 7f8fd3100142295bffa5eabb2ce6f5b5ac163c6b
                    cd ..
                  fi

            - name: Build with Cython speedups
              run: |
                  uv pip install --system --no-build-isolation -e ".[speedups]"

            - name: Verify speedups installed
              run: |
                  python -c "from d810.speedups import cythxr; print('Cython speedups available')" || echo "Speedups not built (expected if compile failed)"

            - name: Install test dependencies
              run: |
                  uv pip install --system pytest pytest-cov

            - name: Run pytest
              run: |
                  pytest tests/unit/ -v --tb=short

    system-tests:
        name: "system-tests (idapro-9.2, pure-python)"
        runs-on: ubuntu-24.04
        env:
            PYTHONPATH: ${{ github.workspace }}
        steps:
            - name: "Checkout ${{ github.ref }} ( ${{ github.sha }} )"
              uses: actions/checkout@v4
              with:
                  persist-credentials: false

            - name: Login to GHCR
              uses: docker/login-action@v3
              with:
                  registry: ghcr.io
                  username: ${{ github.actor }}
                  password: ${{ secrets.GHCR_TOKEN }}

            - name: Cache Docker image
              id: docker-cache
              uses: actions/cache@v4
              with:
                  path: /tmp/docker-cache
                  key: docker-image-${{ runner.os }}-idapro-tests-9.2-${{ hashFiles('docker-compose.yml') }}
                  restore-keys: |
                      docker-image-${{ runner.os }}-idapro-tests-9.2-

            - name: Load cached Docker image
              if: steps.docker-cache.outputs.cache-hit == 'true'
              run: |
                  echo "Loading Docker image from cache..."
                  docker load -i /tmp/docker-cache/idapro-tests-9.2.tar || echo "No cached image to load."

            - name: Run system tests
              run: |
                  set -e
                  docker compose run --rm --entrypoint bash idapro-tests-9.2 -c "
                      set -e
                      cd /work
                      pip install -e .[dev] -q
                      D810_TEST_BINARY=libobfuscated.dll pytest tests/system/ -v --tb=short --forked
                  "

            - name: Save Docker image to cache
              if: steps.docker-cache.outputs.cache-hit != 'true'
              run: |
                  echo "Caching docker image for next run..."
                  mkdir -p /tmp/docker-cache
                  IMAGE_ID=$(docker images --format '{{.Repository}}:{{.Tag}}' | grep idapro-linux | head -1)
                  docker save "$IMAGE_ID" -o /tmp/docker-cache/idapro-tests-9.2.tar || echo "Failed to save image."

    system-tests-speedups:
        name: "system-tests (idapro-9.2, speedups)"
        runs-on: ubuntu-24.04
        env:
            PYTHONPATH: ${{ github.workspace }}
        steps:
            - name: "Checkout ${{ github.ref }} ( ${{ github.sha }} )"
              uses: actions/checkout@v4
              with:
                  persist-credentials: false

            - name: Login to GHCR
              uses: docker/login-action@v3
              with:
                  registry: ghcr.io
                  username: ${{ github.actor }}
                  password: ${{ secrets.GHCR_TOKEN }}

            - name: Cache Docker image
              id: docker-cache
              uses: actions/cache@v4
              with:
                  path: /tmp/docker-cache
                  key: docker-image-${{ runner.os }}-idapro-tests-9.2-${{ hashFiles('docker-compose.yml') }}
                  restore-keys: |
                      docker-image-${{ runner.os }}-idapro-tests-9.2-

            - name: Load cached Docker image
              if: steps.docker-cache.outputs.cache-hit == 'true'
              run: |
                  echo "Loading Docker image from cache..."
                  docker load -i /tmp/docker-cache/idapro-tests-9.2.tar || echo "No cached image to load."

            - name: Build speedups and run system tests
              run: |
                  set -e
                  docker compose run --rm --entrypoint bash idapro-tests-9.2 -c "
                      set -e
                      apt-get update -qq && apt-get install -y -qq g++ >/dev/null
                      cd /work
                      pip install setuptools wheel Cython>=3.0.0 -q
                      D810_BUILD_SPEEDUPS=1 pip install --no-build-isolation -e '.[dev]' -q
                      echo 'Speedups .so files built:'
                      find /work/src/d810/speedups -name '*.so' -type f
                      D810_TEST_BINARY=libobfuscated.dll pytest tests/system/ -v --tb=short --forked
                  "

            - name: Save Docker image to cache
              if: steps.docker-cache.outputs.cache-hit != 'true'
              run: |
                  echo "Caching docker image for next run..."
                  mkdir -p /tmp/docker-cache
                  IMAGE_ID=$(docker images --format '{{.Repository}}:{{.Tag}}' | grep idapro-linux | head -1)
                  docker save "$IMAGE_ID" -o /tmp/docker-cache/idapro-tests-9.2.tar || echo "Failed to save image."
