name: Build and upload to PyPI

on:
    release:
        types:
            - published
    workflow_dispatch:

concurrency:
    group: ${{ github.workflow }}-${{ github.ref || github.run_id }}
    cancel-in-progress: true

jobs:
    build_sdist:
        name: Build source distribution
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
              with:
                  persist-credentials: false

            - name: Display version
              run: |
                  python --version
                  pip --version

            - name: Install pypa/build and pypa/twine
              run: |
                  pip install --upgrade pip
                  pip install --upgrade setuptools==77.0.1
                  pip install --upgrade build==1.3.0
                  pip install --upgrade twine==6.2.0
                  pip install --upgrade packaging==25.0
                  echo "Installed versions:"
                  pip list | grep -E "(twine|packaging|setuptools|build)"

            - name: Build sdist
              run: |
                  rm -rf dist/*
                  python -m build --sdist

            - name: Display content of dist folder
              run: |
                  ls -shR dist/

            - name: Run twine check
              run: |
                  twine check dist/*

            - name: Upload artifact
              uses: actions/upload-artifact@v4
              with:
                  path: ./dist/*.tar.gz
                  name: cibw-sdist

    build_wheels:
        name: Build wheels for ${{ matrix.os }}
        runs-on: ${{ matrix.runs-on }}
        strategy:
            matrix:
                include:
                    - os: linux-intel
                      runs-on: ubuntu-latest
                    - os: windows-intel
                      runs-on: windows-latest
                    - os: macos-intel
                      runs-on: macos-13
                    - os: macos-arm
                      runs-on: macos-latest

        steps:
            - uses: actions/checkout@v4
              with:
                  persist-credentials: false

            - name: Build wheels
              uses: pypa/cibuildwheel@v3.1
              env:
                  CIBW_BUILD: "cp310-* cp311-* cp312-* cp313-*"
                  # Enable optional Cython speedups during wheel build
                  CIBW_ENVIRONMENT: "D810_BUILD_SPEEDUPS=1"
              with:
                  package-dir: .
                  output-dir: wheelhouse
                  config-file: "{package}/pyproject.toml"

            - uses: actions/upload-artifact@v4
              with:
                  name: cibw-wheels-${{ matrix.os }}-${{ strategy.job-index }}
                  path: ./wheelhouse/*.whl

    upload_to_pypi:
        needs: [build_wheels, build_sdist]
        runs-on: ubuntu-latest
        name: Upload to PyPI
        permissions:
            id-token: write
        steps:
            - name: Download dist
              uses: actions/download-artifact@v4
              with:
                  pattern: cibw-*
                  path: dist
                  merge-multiple: true

            - name: Display downloaded files
              run: |
                  ls -shR dist/

            - uses: pypa/gh-action-pypi-publish@release/v1
              if: >-
                  github.repository_owner == 'w00tzenheimer' ||
                  github.repository_owner == 'mahmoudimus'
              with:
                  skip-existing: true
